###########################################################################
# $Id$
###########################################################################

include Makefile

C_HEADERS = graphiqu_enis.h
C_SOURCES = graphiqu_enis.c
C_OBJECTS = $(C_SOURCES:.c=.o)
ADA_HEADERS = graphiqu_enis_binding.ads
ADA_SOURCES = graphiqu_enis_binding.adb
ADA_OBJECTS = $(ADA_SOURCES:.adb=.o)
HEADERS = $(C_HEADERS) $(ADA_HEADERS)
SOURCES = $(C_SOURCES) $(ADA_SOURCES)
OBJECTS = $(C_OBJECTS) $(ADA_OBJECTS)
ALIS    = $(ADA_SOURCES:.adb=.ali)
LIBRARY = libsimplified_graphics.a
HOST = $(shell gcc -dumpmachine)
HOSTLESS_ARCHIVE_DIR = libsimplified_graphics
ARCHIVE_DIR = $(HOSTLESS_ARCHIVE_DIR)-$(HOST)
ARCHIVE_COMAND_ARGS = czvf $(ARCHIVE_DIR).tar.gz $(HOSTLESS_ARCHIVE_DIR)

$(EXECUTABLES): $(LIBRARY)

allclean: clean
	rm -f $(LIBRARY) *.ali b~*
	rm -rf $(HOSTLESS_ARCHIVE_DIR)

dist: allclean
	rm -rf $(HOSTLESS_ARCHIVE_DIR)
	mkdir $(HOSTLESS_ARCHIVE_DIR)
	cp -P Makefile COPYING $(FICHIERS_UTILISATEUR) $(SOURCES) $(HEADERS) \
	  $(HOSTLESS_ARCHIVE_DIR)
	$(MAKE) -f ../mk.dev -C $(HOSTLESS_ARCHIVE_DIR) $(LIBRARY)
	cd $(HOSTLESS_ARCHIVE_DIR) && rm -f $(SOURCES) && cd ..
	$(MAKE) -C $(HOSTLESS_ARCHIVE_DIR) clean
	gtar $(ARCHIVE_COMAND_ARGS) || tar $(ARCHIVE_COMAND_ARGS)

$(C_OBJECTS): $(C_SOURCES)
	for f in $(C_SOURCES); do \
	  gcc $(CFLAGS) -c $${f} || exit 1; \
	done

$(ADA_OBJECTS): $(ADA_SOURCES)
	for f in $(ADA_SOURCES); do \
	  gnat compile -gnatwae -gnatfy -gnatg $${f} || exit 1; \
	done

$(LIBRARY): $(OBJECTS)
	rm -f $@
	ar rcs $@ $(OBJECTS)
	ranlib $@
